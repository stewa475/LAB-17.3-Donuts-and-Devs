import { __decorate, __metadata } from "tslib";
import { AfterContentInit, Component, ContentChildren, ElementRef, HostListener, Input, QueryList } from '@angular/core';
import * as _ from 'lodash';
import { SprkTabbedNavigationPanelDirective } from '../../directives/tabbed-navigation/sprk-tabbed-navigation-panel/sprk-tabbed-navigation-panel.directive';
import { SprkTabbedNavigationTabDirective } from '../../directives/tabbed-navigation/sprk-tabbed-navigation-tab/sprk-tabbed-navigation-tab.directive';
var SprkTabbedNavigationComponent = /** @class */ (function () {
    /**
     * @ignore
     */
    function SprkTabbedNavigationComponent(ref) {
        this.ref = ref;
        /**
         * @ignore
         */
        this.componentID = _.uniqueId();
        /**
         * @ignore
         */
        this.activeClass = 'sprk-c-Tabs__button--active';
        this.ariaOrientation(window.innerWidth, this.ref.nativeElement);
    }
    /**
     * @ignore
     */
    SprkTabbedNavigationComponent.prototype.onClick = function ($event) {
        if ($event.target.classList.contains('sprk-c-Tabs__button')) {
            var activePanel = this.panels.find(function (panel) {
                return (panel.ref.nativeElement.id ===
                    $event.target.getAttribute('aria-controls'));
            });
            this.resetTabs(this.tabs.map(function (tab) { return tab.ref.nativeElement; }), this.panels.map(function (panel) { return panel.ref.nativeElement; }), this.activeClass);
            this.setActiveTab($event.target, activePanel.ref.nativeElement, this.activeClass);
        }
    };
    /**
     * @ignore
     */
    SprkTabbedNavigationComponent.prototype.onResize = function () {
        this.ariaOrientation(window.innerWidth, this.ref.nativeElement);
    };
    /**
     * @ignore
     */
    SprkTabbedNavigationComponent.prototype.onKeydown = function ($event) {
        var isTabsButton = $event.target.classList.contains('sprk-c-Tabs__button');
        if (!isTabsButton) {
            return;
        }
        var keys = {
            end: 35,
            home: 36,
            left: 37,
            up: 38,
            right: 39,
            down: 40,
            tab: 9
        };
        var tabElements = this.tabs.map(function (tab) { return tab.ref.nativeElement; });
        var panelElements = this.panels.map(function (panel) { return panel.ref.nativeElement; });
        if ($event.keyCode === keys.left || $event.keyCode === keys.up) {
            this.incrementTab(tabElements, panelElements, this.activeClass, -1);
        }
        else if ($event.keyCode === keys.right || $event.keyCode === keys.down) {
            this.incrementTab(tabElements, panelElements, this.activeClass, 1);
        }
        else if ($event.keyCode === keys.tab) {
            if ($event.target.getAttribute('role') === 'tab') {
                $event.preventDefault();
                panelElements[this.getActiveTabIndex(tabElements, this.activeClass)].focus();
            }
        }
        else if ($event.keyCode === keys.home) {
            this.goToEndTab(tabElements, panelElements, this.activeClass, -1);
        }
        else if ($event.keyCode === keys.end) {
            this.goToEndTab(tabElements, panelElements, this.activeClass, 1);
        }
    };
    /**
     * @ignore
     */
    SprkTabbedNavigationComponent.prototype.getClasses = function () {
        var classArray = ['sprk-c-Tabs'];
        if (this.additionalClasses) {
            this.additionalClasses.split(' ').forEach(function (className) {
                classArray.push(className);
            });
        }
        return classArray.join(' ');
    };
    /**
     * @ignore
     */
    SprkTabbedNavigationComponent.prototype.ngAfterContentInit = function () {
        var _this = this;
        var tabIDs = [];
        var panelIDs = [];
        if (this.tabs && this.panels) {
            this.tabs.forEach(function (tab, index) {
                var tabID = "tabbed-navigation-" + _this.componentID + "-tab-" + index;
                var panelID = "tabbed-navigation-" + _this.componentID + "-panel-" + index;
                tab.ref.nativeElement.setAttribute('id', tabID);
                tab.ref.nativeElement.setAttribute('aria-controls', panelID);
                tabIDs.push(tabID);
                panelIDs.push(panelID);
            });
            tabIDs = tabIDs.reverse();
            panelIDs = panelIDs.reverse();
            this.panels.forEach(function (panel) {
                panel.ref.nativeElement.setAttribute('id', panelIDs.pop());
                panel.ref.nativeElement.setAttribute('aria-labelledby', tabIDs.pop());
            });
        }
    };
    /**
     * @ignore
     */
    SprkTabbedNavigationComponent.prototype.ariaOrientation = function (width, element) {
        // switch aria-orientation on mobile (based on _tabs.scss breakpoint)
        if (width <= 736) {
            element.setAttribute('aria-orientation', 'vertical');
        }
        else {
            element.setAttribute('aria-orientation', 'horizontal');
        }
    };
    /**
     * @ignore
     */
    SprkTabbedNavigationComponent.prototype.getActiveTabIndex = function (tabs, activeClass) {
        var activeIndex = null;
        tabs.forEach(function (tab, index) {
            if (tab.classList.contains(activeClass || 'sprk-c-Tabs__button--active')) {
                activeIndex = index;
            }
        });
        return activeIndex;
    };
    /**
     * @ignore
     */
    SprkTabbedNavigationComponent.prototype.resetTabs = function (tabs, tabpanels, activeClass) {
        tabs.forEach(function (tab) {
            tab.classList.remove(activeClass || 'sprk-c-Tabs__button--active');
            tab.removeAttribute('tabindex');
            tab.setAttribute('aria-selected', 'false');
            tabpanels.forEach(function (panel) {
                panel.classList.add('sprk-u-HideWhenJs');
            });
        });
    };
    /**
     * @ignore
     */
    SprkTabbedNavigationComponent.prototype.incrementTab = function (tabs, tabpanels, activeClass, direction) {
        var activeIndex = this.getActiveTabIndex(tabs, activeClass);
        var foundNewIndex = false;
        // Start looking for the next available tab
        while (foundNewIndex === false) {
            // if the next tab would be off the left of the tabstrip
            if (activeIndex + direction < 0) {
                // loop to the end and keep looking
                activeIndex = tabs.length;
                // if the next tab would be off the right of the tabstrip
            }
            else if (activeIndex + direction >= tabs.length) {
                // loop back to the beginning and keep looking
                activeIndex = -1;
                // If the next tab is not disabled
            }
            else if (!tabs[activeIndex + direction].hasAttribute('disabled')) {
                // move to the next tab
                activeIndex += direction;
                // stop looking for the correct tab
                foundNewIndex = true;
            }
            else {
                // move to the next tab and keep looking
                activeIndex += direction;
            }
        }
        // deselect all tabs
        this.resetTabs(tabs, tabpanels, activeClass);
        // select the correct tab
        this.setActiveTab(tabs[activeIndex], tabpanels[activeIndex], activeClass);
    };
    SprkTabbedNavigationComponent.prototype.goToEndTab = function (tabs, tabpanels, activeClass, direction) {
        var newActiveIndex;
        // if direction is positive, go to the right-most tab
        if (direction > 0) {
            newActiveIndex = tabs.length - 1;
            // else go to the left-most tab
        }
        else {
            newActiveIndex = 0;
        }
        var foundNewIndex = false;
        // step through the tabs until we find one that isn't disabled
        while (foundNewIndex === false) {
            // if this tab is not disabled
            if (!tabs[newActiveIndex].hasAttribute('disabled')) {
                // stop looking for the correct tab
                foundNewIndex = true;
                // else step one tab away from the end and keep looking
            }
            else {
                newActiveIndex -= direction;
            }
        }
        this.resetTabs(tabs, tabpanels, activeClass);
        this.setActiveTab(tabs[newActiveIndex], tabpanels[newActiveIndex], activeClass);
    };
    /**
     * @ignore
     */
    SprkTabbedNavigationComponent.prototype.setActiveTab = function (tab, tabpanel, activeClass) {
        tab.classList.add(activeClass || 'sprk-c-Tabs__button--active');
        tab.setAttribute('tabindex', '0');
        tab.setAttribute('aria-selected', 'true');
        if (tabpanel) {
            tabpanel.classList.remove('sprk-u-HideWhenJs');
        }
        tab.focus();
    };
    SprkTabbedNavigationComponent.ctorParameters = function () { return [
        { type: ElementRef }
    ]; };
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], SprkTabbedNavigationComponent.prototype, "additionalClasses", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], SprkTabbedNavigationComponent.prototype, "idString", void 0);
    __decorate([
        ContentChildren(SprkTabbedNavigationTabDirective),
        __metadata("design:type", QueryList)
    ], SprkTabbedNavigationComponent.prototype, "tabs", void 0);
    __decorate([
        ContentChildren(SprkTabbedNavigationPanelDirective),
        __metadata("design:type", QueryList)
    ], SprkTabbedNavigationComponent.prototype, "panels", void 0);
    __decorate([
        HostListener('click', ['$event']),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", [Object]),
        __metadata("design:returntype", void 0)
    ], SprkTabbedNavigationComponent.prototype, "onClick", null);
    __decorate([
        HostListener('window:resize'),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", []),
        __metadata("design:returntype", void 0)
    ], SprkTabbedNavigationComponent.prototype, "onResize", null);
    __decorate([
        HostListener('keydown', ['$event']),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", [Object]),
        __metadata("design:returntype", void 0)
    ], SprkTabbedNavigationComponent.prototype, "onKeydown", null);
    SprkTabbedNavigationComponent = __decorate([
        Component({
            selector: 'sprk-tabbed-navigation',
            template: "\n    <div [ngClass]=\"getClasses()\" [attr.data-id]=\"idString\">\n      <div class=\"sprk-c-Tabs__buttons\" role=\"tablist\">\n        <ng-content select=\"[sprkTabbedNavigationTab]\"></ng-content>\n      </div>\n      <ng-content select=\"[sprkTabbedNavigationPane]\"></ng-content>\n      <ng-content></ng-content>\n    </div>\n  "
        }),
        __metadata("design:paramtypes", [ElementRef])
    ], SprkTabbedNavigationComponent);
    return SprkTabbedNavigationComponent;
}());
export { SprkTabbedNavigationComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3Byay10YWJiZWQtbmF2aWdhdGlvbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ac3BhcmtkZXNpZ25zeXN0ZW0vc3BhcmstYW5ndWxhci8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL3NwcmstdGFiYmVkLW5hdmlnYXRpb24vc3Byay10YWJiZWQtbmF2aWdhdGlvbi5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsU0FBUyxFQUNULGVBQWUsRUFDZixVQUFVLEVBQ1YsWUFBWSxFQUNaLEtBQUssRUFDTCxTQUFTLEVBQ1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxLQUFLLENBQUMsTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxFQUNMLGtDQUFrQyxFQUNuQyxNQUFNLHdHQUF3RyxDQUFDO0FBQ2hILE9BQU8sRUFDTCxnQ0FBZ0MsRUFDakMsTUFBTSxvR0FBb0csQ0FBQztBQWM1RztJQStSRTs7T0FFRztJQUNILHVDQUFtQixHQUFlO1FBQWYsUUFBRyxHQUFILEdBQUcsQ0FBWTtRQWxRbEM7O1dBRUc7UUFDSCxnQkFBVyxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUMzQjs7V0FFRztRQUNILGdCQUFXLEdBQUcsNkJBQTZCLENBQUM7UUE0UDFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUEzUEQ7O09BRUc7SUFFSCwrQ0FBTyxHQUFQLFVBQVEsTUFBTTtRQUNaLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLHFCQUFxQixDQUFDLEVBQUU7WUFDM0QsSUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBQSxLQUFLO2dCQUN4QyxPQUFPLENBQ0wsS0FBSyxDQUFDLEdBQUcs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QUMsUUFBUSxDQUFDLENBQUM7Ozs7a0VBb0NuQztJQW5IVSw2QkFBNkI7UUFaekMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLHdCQUF3QjtZQUNsQyxRQUFRLEVBQUUsK1VBUVQ7U0FDRixDQUFDO3lDQW1Td0IsVUFBVTtPQWxTdkIsNkJBQTZCLENBcVN6QztJQUFELG9DQUFDO0NBQUEsQUFyU0QsSUFxU0M7U0FyU1ksNkJBQTZCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWZ0ZXJDb250ZW50SW5pdCxcbiAgQ29tcG9uZW50LFxuICBDb250ZW50Q2hpbGRyZW4sXG4gIEVsZW1lbnRSZWYsXG4gIEhvc3RMaXN0ZW5lcixcbiAgSW5wdXQsXG4gIFF1ZXJ5TGlzdFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7XG4gIFNwcmtUYWJiZWROYXZpZ2F0aW9uUGFuZWxEaXJlY3RpdmVcbn0gZnJvbSAnLi4vLi4vZGlyZWN0aXZlcy90YWJiZWQtbmF2aWdhdGlvbi9zcHJrLXRhYmJlZC1uYXZpZ2F0aW9uLXBhbmVsL3NwcmstdGFiYmVkLW5hdmlnYXRpb24tcGFuZWwuZGlyZWN0aXZlJztcbmltcG9ydCB7XG4gIFNwcmtUYWJiZWROYXZpZ2F0aW9uVGFiRGlyZWN0aXZlXG59IGZyb20gJy4uLy4uL2RpcmVjdGl2ZXMvdGFiYmVkLW5hdmlnYXRpb24vc3Byay10YWJiZWQtbmF2aWdhdGlvbi10YWIvc3Byay10YWJiZWQtbmF2aWdhdGlvbi10YWIuZGlyZWN0aXZlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnc3Byay10YWJiZWQtbmF2aWdhdGlvbicsXG4gIHRlbXBsYXRlOiBgXG4gICAgPGRpdiBbbmdDbGFzc109XCJnZXRDbGFzc2VzKClcIiBbYXR0ci5kYXRhLWlkXT1cImlkU3RyaW5nXCI+XG4gICAgICA8ZGl2IGNsYXNzPVwic3Byay1jLVRhYnNfX2J1dHRvbnNcIiByb2xlPVwidGFibGlzdFwiPlxuICAgICAgICA8bmctY29udGVudCBzZWxlY3Q9XCJbc3Bya1RhYmJlZE5hdmlnYXRpb25UYWJdXCI+PC9uZy1jb250ZW50PlxuICAgICAgPC9kaXY+XG4gICAgICA8bmctY29udGVudCBzZWxlY3Q9XCJbc3Bya1RhYmJlZE5hdmlnYXRpb25QYW5lXVwiPjwvbmctY29udGVudD5cbiAgICAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cbiAgICA8L2Rpdj5cbiAgYFxufSlcbmV4cG9ydCBjbGFzcyBTcHJrVGFiYmVkTmF2aWdhdGlvbkNvbXBvbmVudCBpbXBsZW1lbnRzIEFmdGVyQ29udGVudEluaXQge1xuICAvKipcbiAgICogRXhwZWN0cyBhIHNwYWNlIHNlcGFyYXRlZCBzdHJpbmdcbiAgICogb2YgY2xhc3NlcyB0byBiZSBhZGRlZCB0byB0aGVcbiAgICogY29tcG9uZW50LlxuICAgKi9cbiAgQElucHV0KClcbiAgYWRkaXRpb25hbENsYXNzZXM6IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSB2YWx1ZSBzdXBwbGllZCB3aWxsIGJlIGFzc2lnbmVkXG4gICAqIHRvIHRoZSBgZGF0YS1pZGAgYXR0cmlidXRlIG9uIHRoZVxuICAgKiBjb21wb25lbnQuIFRoaXMgaXMgaW50ZW5kZWQgdG8gYmVcbiAgICogdXNlZCBhcyBhIHNlbGVjdG9yIGZvciBhdXRvbWF0ZWRcbiAgICogdG9vbHMuIFRoaXMgdmFsdWUgc2hvdWxkIGJlIHVuaXF1ZVxuICAgKiBwZXIgcGFnZS5cbiAgICovXG4gIEBJbnB1dCgpXG4gIGlkU3RyaW5nOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGlzIGNvbXBvbmVudCBleHBlY3RzIGNoaWxkcmVuIGA8YnV0dG9uPmAgZWxlbWVudHNcbiAgICogd2l0aCB0aGUgYFNwcmtUYWJiZWROYXZpZ2F0aW9uVGFiRGlyZWN0aXZlYCBvbiB0aGVtLlxuICAgKiBUaGVzZSBzZXJ2ZSBhcyB0aGUgVGFicy5cbiAgICovXG4gIEBDb250ZW50Q2hpbGRyZW4oU3Bya1RhYmJlZE5hdmlnYXRpb25UYWJEaXJlY3RpdmUpXG4gIHRhYnM6IFF1ZXJ5TGlzdDxTcHJrVGFiYmVkTmF2aWdhdGlvblRhYkRpcmVjdGl2ZT47XG4gIC8qKlxuICAgKiBUaGlzIGNvbXBvbmVudCBleHBlY3RzIGNoaWxkcmVuIGA8ZGl2PmAgZWxlbWVudHNcbiAgICogd2l0aCB0aGUgYFNwcmtUYWJiZWROYXZpZ2F0aW9uUGFuZWxEaXJlY3RpdmVgIG9uIHRoZW0uXG4gICAqIFRoZXNlIHNlcnZlIGFzIHRoZSBQYW5lbHMuXG4gICAqL1xuICBAQ29udGVudENoaWxkcmVuKFNwcmtUYWJiZWROYXZpZ2F0aW9uUGFuZWxEaXJlY3RpdmUpXG4gIHBhbmVsczogUXVlcnlMaXN0PFNwcmtUYWJiZWROYXZpZ2F0aW9uUGFuZWxEaXJlY3RpdmU+O1xuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgY29tcG9uZW50SUQgPSBfLnVuaXF1ZUlkKCk7XG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBhY3RpdmVDbGFzcyA9ICdzcHJrLWMtVGFic19fYnV0dG9uLS1hY3RpdmUnO1xuXG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBASG9zdExpc3RlbmVyKCdjbGljaycsIFsnJGV2ZW50J10pXG4gIG9uQ2xpY2soJGV2ZW50KSB7XG4gICAgaWYgKCRldmVudC50YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKCdzcHJrLWMtVGFic19fYnV0dG9uJykpIHtcbiAgICAgIGNvbnN0IGFjdGl2ZVBhbmVsID0gdGhpcy5wYW5lbHMuZmluZChwYW5lbCA9PiB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgcGFuZWwucmVmLm5hdGl2ZUVsZW1lbnQuaWQgPT09XG4gICAgICAgICAgJGV2ZW50LnRhcmdldC5nZXRBdHRyaWJ1dGUoJ2FyaWEtY29udHJvbHMnKVxuICAgICAgICApO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMucmVzZXRUYWJzKFxuICAgICAgICB0aGlzLnRhYnMubWFwKHRhYiA9PiB0YWIucmVmLm5hdGl2ZUVsZW1lbnQpLFxuICAgICAgICB0aGlzLnBhbmVscy5tYXAocGFuZWwgPT4gcGFuZWwucmVmLm5hdGl2ZUVsZW1lbnQpLFxuICAgICAgICB0aGlzLmFjdGl2ZUNsYXNzXG4gICAgICApO1xuXG4gICAgICB0aGlzLnNldEFjdGl2ZVRhYihcbiAgICAgICAgJGV2ZW50LnRhcmdldCxcbiAgICAgICAgYWN0aXZlUGFuZWwucmVmLm5hdGl2ZUVsZW1lbnQsXG4gICAgICAgIHRoaXMuYWN0aXZlQ2xhc3NcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIEBIb3N0TGlzdGVuZXIoJ3dpbmRvdzpyZXNpemUnKVxuICBvblJlc2l6ZSgpIHtcbiAgICB0aGlzLmFyaWFPcmllbnRhdGlvbih3aW5kb3cuaW5uZXJXaWR0aCwgdGhpcy5yZWYubmF0aXZlRWxlbWVudCk7XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bicsIFsnJGV2ZW50J10pXG4gIG9uS2V5ZG93bigkZXZlbnQpIHtcbiAgICBjb25zdCBpc1RhYnNCdXR0b24gPSAkZXZlbnQudGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucygnc3Byay1jLVRhYnNfX2J1dHRvbicpO1xuICAgIGlmICghaXNUYWJzQnV0dG9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3Qga2V5cyA9IHtcbiAgICAgIGVuZDogMzUsXG4gICAgICBob21lOiAzNixcbiAgICAgIGxlZnQ6IDM3LFxuICAgICAgdXA6IDM4LFxuICAgICAgcmlnaHQ6IDM5LFxuICAgICAgZG93bjogNDAsXG4gICAgICB0YWI6IDlcbiAgICB9O1xuXG4gICAgY29uc3QgdGFiRWxlbWVudHMgPSB0aGlzLnRhYnMubWFwKHRhYiA9PiB0YWIucmVmLm5hdGl2ZUVsZW1lbnQpO1xuICAgIGNvbnN0IHBhbmVsRWxlbWVudHMgPSB0aGlzLnBhbmVscy5tYXAocGFuZWwgPT4gcGFuZWwucmVmLm5hdGl2ZUVsZW1lbnQpO1xuXG4gICAgaWYgKCRldmVudC5rZXlDb2RlID09PSBrZXlzLmxlZnQgfHwgJGV2ZW50LmtleUNvZGUgPT09IGtleXMudXApIHtcbiAgICAgIHRoaXMuaW5jcmVtZW50VGFiKHRhYkVsZW1lbnRzLCBwYW5lbEVsZW1lbnRzLCB0aGlzLmFjdGl2ZUNsYXNzLCAtMSk7XG4gICAgfSBlbHNlIGlmICgkZXZlbnQua2V5Q29kZSA9PT0ga2V5cy5yaWdodCB8fCAkZXZlbnQua2V5Q29kZSA9PT0ga2V5cy5kb3duKSB7XG4gICAgICB0aGlzLmluY3JlbWVudFRhYih0YWJFbGVtZW50cywgcGFuZWxFbGVtZW50cywgdGhpcy5hY3RpdmVDbGFzcywgMSk7XG4gICAgfSBlbHNlIGlmICgkZXZlbnQua2V5Q29kZSA9PT0ga2V5cy50YWIpIHtcbiAgICAgIGlmICgkZXZlbnQudGFyZ2V0LmdldEF0dHJpYnV0ZSgncm9sZScpID09PSAndGFiJykge1xuICAgICAgICAkZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgcGFuZWxFbGVtZW50c1tcbiAgICAgICAgICB0aGlzLmdldEFjdGl2ZVRhYkluZGV4KHRhYkVsZW1lbnRzLCB0aGlzLmFjdGl2ZUNsYXNzKVxuICAgICAgICBdLmZvY3VzKCk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmICgkZXZlbnQua2V5Q29kZSA9PT0ga2V5cy5ob21lKSB7XG4gICAgICB0aGlzLmdvVG9FbmRUYWIodGFiRWxlbWVudHMsIHBhbmVsRWxlbWVudHMsIHRoaXMuYWN0aXZlQ2xhc3MsIC0xKTtcbiAgICB9IGVsc2UgaWYgKCRldmVudC5rZXlDb2RlID09PSBrZXlzLmVuZCkge1xuICAgICAgdGhpcy5nb1RvRW5kVGFiKHRhYkVsZW1lbnRzLCBwYW5lbEVsZW1lbnRzLCB0aGlzLmFjdGl2ZUNsYXNzLCAxKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgZ2V0Q2xhc3NlcygpOiBzdHJpbmcge1xuICAgIGNvbnN0IGNsYXNzQXJyYXk6IHN0cmluZ1tdID0gWydzcHJrLWMtVGFicyddO1xuXG4gICAgaWYgKHRoaXMuYWRkaXRpb25hbENsYXNzZXMpIHtcbiAgICAgIHRoaXMuYWRkaXRpb25hbENsYXNzZXMuc3BsaXQoJyAnKS5mb3JFYWNoKGNsYXNzTmFtZSA9PiB7XG4gICAgICAgIGNsYXNzQXJyYXkucHVzaChjbGFzc05hbWUpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNsYXNzQXJyYXkuam9pbignICcpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIG5nQWZ0ZXJDb250ZW50SW5pdCgpOiB2b2lkIHtcbiAgICBsZXQgdGFiSURzID0gW107XG4gICAgbGV0IHBhbmVsSURzID0gW107XG5cbiAgICBpZiAodGhpcy50YWJzICYmIHRoaXMucGFuZWxzKSB7XG4gICAgICB0aGlzLnRhYnMuZm9yRWFjaCgodGFiLCBpbmRleCkgPT4ge1xuICAgICAgICBjb25zdCB0YWJJRCA9IGB0YWJiZWQtbmF2aWdhdGlvbi0ke3RoaXMuY29tcG9uZW50SUR9LXRhYi0ke2luZGV4fWA7XG4gICAgICAgIGNvbnN0IHBhbmVsSUQgPSBgdGFiYmVkLW5hdmlnYXRpb24tJHt0aGlzLmNvbXBvbmVudElEfS1wYW5lbC0ke2luZGV4fWA7XG5cbiAgICAgICAgdGFiLnJlZi5uYXRpdmVFbGVtZW50LnNldEF0dHJpYnV0ZSgnaWQnLCB0YWJJRCk7XG4gICAgICAgIHRhYi5yZWYubmF0aXZlRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2FyaWEtY29udHJvbHMnLCBwYW5lbElEKTtcbiAgICAgICAgdGFiSURzLnB1c2godGFiSUQpO1xuICAgICAgICBwYW5lbElEcy5wdXNoKHBhbmVsSUQpO1xuICAgICAgfSk7XG5cbiAgICAgIHRhYklEcyA9IHRhYklEcy5yZXZlcnNlKCk7XG4gICAgICBwYW5lbElEcyA9IHBhbmVsSURzLnJldmVyc2UoKTtcblxuICAgICAgdGhpcy5wYW5lbHMuZm9yRWFjaChwYW5lbCA9PiB7XG4gICAgICAgIHBhbmVsLnJlZi5uYXRpdmVFbGVtZW50LnNldEF0dHJpYnV0ZSgnaWQnLCBwYW5lbElEcy5wb3AoKSk7XG4gICAgICAgIHBhbmVsLnJlZi5uYXRpdmVFbGVtZW50LnNldEF0dHJpYnV0ZSgnYXJpYS1sYWJlbGxlZGJ5JywgdGFiSURzLnBvcCgpKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBhcmlhT3JpZW50YXRpb24od2lkdGgsIGVsZW1lbnQpIHtcbiAgICAvLyBzd2l0Y2ggYXJpYS1vcmllbnRhdGlvbiBvbiBtb2JpbGUgKGJhc2VkIG9uIF90YWJzLnNjc3MgYnJlYWtwb2ludClcbiAgICBpZiAod2lkdGggPD0gNzM2KSB7XG4gICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnYXJpYS1vcmllbnRhdGlvbicsICd2ZXJ0aWNhbCcpO1xuICAgIH0gZWxzZSB7XG4gICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnYXJpYS1vcmllbnRhdGlvbicsICdob3Jpem9udGFsJyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIGdldEFjdGl2ZVRhYkluZGV4KHRhYnMsIGFjdGl2ZUNsYXNzKSB7XG4gICAgbGV0IGFjdGl2ZUluZGV4ID0gbnVsbDtcbiAgICB0YWJzLmZvckVhY2goKHRhYiwgaW5kZXgpID0+IHtcbiAgICAgIGlmIChcbiAgICAgICAgdGFiLmNsYXNzTGlzdC5jb250YWlucyhhY3RpdmVDbGFzcyB8fCAnc3Byay1jLVRhYnNfX2J1dHRvbi0tYWN0aXZlJylcbiAgICAgICkge1xuICAgICAgICBhY3RpdmVJbmRleCA9IGluZGV4O1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGFjdGl2ZUluZGV4O1xuICB9XG5cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIHJlc2V0VGFicyh0YWJzLCB0YWJwYW5lbHMsIGFjdGl2ZUNsYXNzKSB7XG4gICAgdGFicy5mb3JFYWNoKHRhYiA9PiB7XG4gICAgICB0YWIuY2xhc3NMaXN0LnJlbW92ZShhY3RpdmVDbGFzcyB8fCAnc3Byay1jLVRhYnNfX2J1dHRvbi0tYWN0aXZlJyk7XG4gICAgICB0YWIucmVtb3ZlQXR0cmlidXRlKCd0YWJpbmRleCcpO1xuICAgICAgdGFiLnNldEF0dHJpYnV0ZSgnYXJpYS1zZWxlY3RlZCcsICdmYWxzZScpO1xuICAgICAgdGFicGFuZWxzLmZvckVhY2gocGFuZWwgPT4ge1xuICAgICAgICBwYW5lbC5jbGFzc0xpc3QuYWRkKCdzcHJrLXUtSGlkZVdoZW5KcycpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgaW5jcmVtZW50VGFiKHRhYnMsIHRhYnBhbmVscywgYWN0aXZlQ2xhc3MsIGRpcmVjdGlvbikge1xuICAgIGxldCBhY3RpdmVJbmRleCA9IHRoaXMuZ2V0QWN0aXZlVGFiSW5kZXgodGFicywgYWN0aXZlQ2xhc3MpO1xuXG4gICAgbGV0IGZvdW5kTmV3SW5kZXggPSBmYWxzZTtcblxuICAgIC8vIFN0YXJ0IGxvb2tpbmcgZm9yIHRoZSBuZXh0IGF2YWlsYWJsZSB0YWJcbiAgICB3aGlsZSAoZm91bmROZXdJbmRleCA9PT0gZmFsc2UpIHtcbiAgICAgIC8vIGlmIHRoZSBuZXh0IHRhYiB3b3VsZCBiZSBvZmYgdGhlIGxlZnQgb2YgdGhlIHRhYnN0cmlwXG4gICAgICBpZiAoYWN0aXZlSW5kZXggKyBkaXJlY3Rpb24gPCAwKSB7XG4gICAgICAgIC8vIGxvb3AgdG8gdGhlIGVuZCBhbmQga2VlcCBsb29raW5nXG4gICAgICAgIGFjdGl2ZUluZGV4ID0gdGFicy5sZW5ndGg7XG5cbiAgICAgIC8vIGlmIHRoZSBuZXh0IHRhYiB3b3VsZCBiZSBvZmYgdGhlIHJpZ2h0IG9mIHRoZSB0YWJzdHJpcFxuICAgICAgfSBlbHNlIGlmIChhY3RpdmVJbmRleCArIGRpcmVjdGlvbiA+PSB0YWJzLmxlbmd0aCkge1xuICAgICAgICAvLyBsb29wIGJhY2sgdG8gdGhlIGJlZ2lubmluZyBhbmQga2VlcCBsb29raW5nXG4gICAgICAgIGFjdGl2ZUluZGV4ID0gLTE7XG5cbiAgICAgIC8vIElmIHRoZSBuZXh0IHRhYiBpcyBub3QgZGlzYWJsZWRcbiAgICAgIH0gZWxzZSBpZiAoIXRhYnNbYWN0aXZlSW5kZXggKyBkaXJlY3Rpb25dLmhhc0F0dHJpYnV0ZSgnZGlzYWJsZWQnKSkge1xuICAgICAgICAvLyBtb3ZlIHRvIHRoZSBuZXh0IHRhYlxuICAgICAgICBhY3RpdmVJbmRleCArPSBkaXJlY3Rpb247XG4gICAgICAgIC8vIHN0b3AgbG9va2luZyBmb3IgdGhlIGNvcnJlY3QgdGFiXG4gICAgICAgIGZvdW5kTmV3SW5kZXggPSB0cnVlO1xuXG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBtb3ZlIHRvIHRoZSBuZXh0IHRhYiBhbmQga2VlcCBsb29raW5nXG4gICAgICAgIGFjdGl2ZUluZGV4ICs9IGRpcmVjdGlvbjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBkZXNlbGVjdCBhbGwgdGFic1xuICAgIHRoaXMucmVzZXRUYWJzKHRhYnMsIHRhYnBhbmVscywgYWN0aXZlQ2xhc3MpO1xuICAgIC8vIHNlbGVjdCB0aGUgY29ycmVjdCB0YWJcbiAgICB0aGlzLnNldEFjdGl2ZVRhYih0YWJzW2FjdGl2ZUluZGV4XSwgdGFicGFuZWxzW2FjdGl2ZUluZGV4XSwgYWN0aXZlQ2xhc3MpO1xuICB9XG5cbiAgZ29Ub0VuZFRhYih0YWJzLCB0YWJwYW5lbHMsIGFjdGl2ZUNsYXNzLCBkaXJlY3Rpb24pIHtcbiAgICBsZXQgbmV3QWN0aXZlSW5kZXg7XG5cbiAgICAvLyBpZiBkaXJlY3Rpb24gaXMgcG9zaXRpdmUsIGdvIHRvIHRoZSByaWdodC1tb3N0IHRhYlxuICAgIGlmIChkaXJlY3Rpb24gPiAwKSB7XG4gICAgICBuZXdBY3RpdmVJbmRleCA9IHRhYnMubGVuZ3RoIC0gMTtcblxuICAgIC8vIGVsc2UgZ28gdG8gdGhlIGxlZnQtbW9zdCB0YWJcbiAgICB9IGVsc2Uge1xuICAgICAgbmV3QWN0aXZlSW5kZXggPSAwO1xuICAgIH1cblxuICAgIGxldCBmb3VuZE5ld0luZGV4ID0gZmFsc2U7XG5cbiAgICAvLyBzdGVwIHRocm91Z2ggdGhlIHRhYnMgdW50aWwgd2UgZmluZCBvbmUgdGhhdCBpc24ndCBkaXNhYmxlZFxuICAgIHdoaWxlIChmb3VuZE5ld0luZGV4ID09PSBmYWxzZSkge1xuXG4gICAgICAvLyBpZiB0aGlzIHRhYiBpcyBub3QgZGlzYWJsZWRcbiAgICAgIGlmICghdGFic1tuZXdBY3RpdmVJbmRleF0uaGFzQXR0cmlidXRlKCdkaXNhYmxlZCcpKSB7XG5cbiAgICAgICAgLy8gc3RvcCBsb29raW5nIGZvciB0aGUgY29ycmVjdCB0YWJcbiAgICAgICAgZm91bmROZXdJbmRleCA9IHRydWU7XG5cbiAgICAgIC8vIGVsc2Ugc3RlcCBvbmUgdGFiIGF3YXkgZnJvbSB0aGUgZW5kIGFuZCBrZWVwIGxvb2tpbmdcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5ld0FjdGl2ZUluZGV4IC09IGRpcmVjdGlvbjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLnJlc2V0VGFicyh0YWJzLCB0YWJwYW5lbHMsIGFjdGl2ZUNsYXNzKTtcbiAgICB0aGlzLnNldEFjdGl2ZVRhYih0YWJzW25ld0FjdGl2ZUluZGV4XSwgdGFicGFuZWxzW25ld0FjdGl2ZUluZGV4XSwgYWN0aXZlQ2xhc3MpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIHNldEFjdGl2ZVRhYih0YWIsIHRhYnBhbmVsLCBhY3RpdmVDbGFzcykge1xuICAgIHRhYi5jbGFzc0xpc3QuYWRkKGFjdGl2ZUNsYXNzIHx8ICdzcHJrLWMtVGFic19fYnV0dG9uLS1hY3RpdmUnKTtcbiAgICB0YWIuc2V0QXR0cmlidXRlKCd0YWJpbmRleCcsICcwJyk7XG4gICAgdGFiLnNldEF0dHJpYnV0ZSgnYXJpYS1zZWxlY3RlZCcsICd0cnVlJyk7XG4gICAgaWYgKHRhYnBhbmVsKSB7XG4gICAgICB0YWJwYW5lbC5jbGFzc0xpc3QucmVtb3ZlKCdzcHJrLXUtSGlkZVdoZW5KcycpO1xuICAgIH1cbiAgICB0YWIuZm9jdXMoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgcmVmOiBFbGVtZW50UmVmKSB7XG4gICAgdGhpcy5hcmlhT3JpZW50YXRpb24od2luZG93LmlubmVyV2lkdGgsIHRoaXMucmVmLm5hdGl2ZUVsZW1lbnQpO1xuICB9XG59XG4iXX0=