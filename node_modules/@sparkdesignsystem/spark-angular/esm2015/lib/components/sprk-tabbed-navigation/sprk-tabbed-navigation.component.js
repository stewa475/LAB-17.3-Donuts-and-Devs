import { __decorate, __metadata } from "tslib";
import { AfterContentInit, Component, ContentChildren, ElementRef, HostListener, Input, QueryList } from '@angular/core';
import * as _ from 'lodash';
import { SprkTabbedNavigationPanelDirective } from '../../directives/tabbed-navigation/sprk-tabbed-navigation-panel/sprk-tabbed-navigation-panel.directive';
import { SprkTabbedNavigationTabDirective } from '../../directives/tabbed-navigation/sprk-tabbed-navigation-tab/sprk-tabbed-navigation-tab.directive';
let SprkTabbedNavigationComponent = class SprkTabbedNavigationComponent {
    /**
     * @ignore
     */
    constructor(ref) {
        this.ref = ref;
        /**
         * @ignore
         */
        this.componentID = _.uniqueId();
        /**
         * @ignore
         */
        this.activeClass = 'sprk-c-Tabs__button--active';
        this.ariaOrientation(window.innerWidth, this.ref.nativeElement);
    }
    /**
     * @ignore
     */
    onClick($event) {
        if ($event.target.classList.contains('sprk-c-Tabs__button')) {
            const activePanel = this.panels.find(panel => {
                return (panel.ref.nativeElement.id ===
                    $event.target.getAttribute('aria-controls'));
            });
            this.resetTabs(this.tabs.map(tab => tab.ref.nativeElement), this.panels.map(panel => panel.ref.nativeElement), this.activeClass);
            this.setActiveTab($event.target, activePanel.ref.nativeElement, this.activeClass);
        }
    }
    /**
     * @ignore
     */
    onResize() {
        this.ariaOrientation(window.innerWidth, this.ref.nativeElement);
    }
    /**
     * @ignore
     */
    onKeydown($event) {
        const isTabsButton = $event.target.classList.contains('sprk-c-Tabs__button');
        if (!isTabsButton) {
            return;
        }
        const keys = {
            end: 35,
            home: 36,
            left: 37,
            up: 38,
            right: 39,
            down: 40,
            tab: 9
        };
        const tabElements = this.tabs.map(tab => tab.ref.nativeElement);
        const panelElements = this.panels.map(panel => panel.ref.nativeElement);
        if ($event.keyCode === keys.left || $event.keyCode === keys.up) {
            this.incrementTab(tabElements, panelElements, this.activeClass, -1);
        }
        else if ($event.keyCode === keys.right || $event.keyCode === keys.down) {
            this.incrementTab(tabElements, panelElements, this.activeClass, 1);
        }
        else if ($event.keyCode === keys.tab) {
            if ($event.target.getAttribute('role') === 'tab') {
                $event.preventDefault();
                panelElements[this.getActiveTabIndex(tabElements, this.activeClass)].focus();
            }
        }
        else if ($event.keyCode === keys.home) {
            this.goToEndTab(tabElements, panelElements, this.activeClass, -1);
        }
        else if ($event.keyCode === keys.end) {
            this.goToEndTab(tabElements, panelElements, this.activeClass, 1);
        }
    }
    /**
     * @ignore
     */
    getClasses() {
        const classArray = ['sprk-c-Tabs'];
        if (this.additionalClasses) {
            this.additionalClasses.split(' ').forEach(className => {
                classArray.push(className);
            });
        }
        return classArray.join(' ');
    }
    /**
     * @ignore
     */
    ngAfterContentInit() {
        let tabIDs = [];
        let panelIDs = [];
        if (this.tabs && this.panels) {
            this.tabs.forEach((tab, index) => {
                const tabID = `tabbed-navigation-${this.componentID}-tab-${index}`;
                const panelID = `tabbed-navigation-${this.componentID}-panel-${index}`;
                tab.ref.nativeElement.setAttribute('id', tabID);
                tab.ref.nativeElement.setAttribute('aria-controls', panelID);
                tabIDs.push(tabID);
                panelIDs.push(panelID);
            });
            tabIDs = tabIDs.reverse();
            panelIDs = panelIDs.reverse();
            this.panels.forEach(panel => {
                panel.ref.nativeElement.setAttribute('id', panelIDs.pop());
                panel.ref.nativeElement.setAttribute('aria-labelledby', tabIDs.pop());
            });
        }
    }
    /**
     * @ignore
     */
    ariaOrientation(width, element) {
        // switch aria-orientation on mobile (based on _tabs.scss breakpoint)
        if (width <= 736) {
            element.setAttribute('aria-orientation', 'vertical');
        }
        else {
            element.setAttribute('aria-orientation', 'horizontal');
        }
    }
    /**
     * @ignore
     */
    getActiveTabIndex(tabs, activeClass) {
        let activeIndex = null;
        tabs.forEach((tab, index) => {
            if (tab.classList.contains(activeClass || 'sprk-c-Tabs__button--active')) {
                activeIndex = index;
            }
        });
        return activeIndex;
    }
    /**
     * @ignore
     */
    resetTabs(tabs, tabpanels, activeClass) {
        tabs.forEach(tab => {
            tab.classList.remove(activeClass || 'sprk-c-Tabs__button--active');
            tab.removeAttribute('tabindex');
            tab.setAttribute('aria-selected', 'false');
            tabpanels.forEach(panel => {
                panel.classList.add('sprk-u-HideWhenJs');
            });
        });
    }
    /**
     * @ignore
     */
    incrementTab(tabs, tabpanels, activeClass, direction) {
        let activeIndex = this.getActiveTabIndex(tabs, activeClass);
        let foundNewIndex = false;
        // Start looking for the next available tab
        while (foundNewIndex === false) {
            // if the next tab would be off the left of the tabstrip
            if (activeIndex + direction < 0) {
                // loop to the end and keep looking
                activeIndex = tabs.length;
                // if the next tab would be off the right of the tabstrip
            }
            else if (activeIndex + direction >= tabs.length) {
                // loop back to the beginning and keep looking
                activeIndex = -1;
                // If the next tab is not disabled
            }
            else if (!tabs[activeIndex + direction].hasAttribute('disabled')) {
                // move to the next tab
                activeIndex += direction;
                // stop looking for the correct tab
                foundNewIndex = true;
            }
            else {
                // move to the next tab and keep looking
                activeIndex += direction;
            }
        }
        // deselect all tabs
        this.resetTabs(tabs, tabpanels, activeClass);
        // select the correct tab
        this.setActiveTab(tabs[activeIndex], tabpanels[activeIndex], activeClass);
    }
    goToEndTab(tabs, tabpanels, activeClass, direction) {
        let newActiveIndex;
        // if direction is positive, go to the right-most tab
        if (direction > 0) {
            newActiveIndex = tabs.length - 1;
            // else go to the left-most tab
        }
        else {
            newActiveIndex = 0;
        }
        let foundNewIndex = false;
        // step through the tabs until we find one that isn't disabled
        while (foundNewIndex === false) {
            // if this tab is not disabled
            if (!tabs[newActiveIndex].hasAttribute('disabled')) {
                // stop looking for the correct tab
                foundNewIndex = true;
                // else step one tab away from the end and keep looking
            }
            else {
                newActiveIndex -= direction;
            }
        }
        this.resetTabs(tabs, tabpanels, activeClass);
        this.setActiveTab(tabs[newActiveIndex], tabpanels[newActiveIndex], activeClass);
    }
    /**
     * @ignore
     */
    setActiveTab(tab, tabpanel, activeClass) {
        tab.classList.add(activeClass || 'sprk-c-Tabs__button--active');
        tab.setAttribute('tabindex', '0');
        tab.setAttribute('aria-selected', 'true');
        if (tabpanel) {
            tabpanel.classList.remove('sprk-u-HideWhenJs');
        }
        tab.focus();
    }
};
SprkTabbedNavigationComponent.ctorParameters = () => [
    { type: ElementRef }
];
__decorate([
    Input(),
    __metadata("design:type", String)
], SprkTabbedNavigationComponent.prototype, "additionalClasses", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], SprkTabbedNavigationComponent.prototype, "idString", void 0);
__decorate([
    ContentChildren(SprkTabbedNavigationTabDirective),
    __metadata("design:type", QueryList)
], SprkTabbedNavigationComponent.prototype, "tabs", void 0);
__decorate([
    ContentChildren(SprkTabbedNavigationPanelDirective),
    __metadata("design:type", QueryList)
], SprkTabbedNavigationComponent.prototype, "panels", void 0);
__decorate([
    HostListener('click', ['$event']),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", void 0)
], SprkTabbedNavigationComponent.prototype, "onClick", null);
__decorate([
    HostListener('window:resize'),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", void 0)
], SprkTabbedNavigationComponent.prototype, "onResize", null);
__decorate([
    HostListener('keydown', ['$event']),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", void 0)
], SprkTabbedNavigationComponent.prototype, "onKeydown", null);
SprkTabbedNavigationComponent = __decorate([
    Component({
        selector: 'sprk-tabbed-navigation',
        template: `
    <div [ngClass]="getClasses()" [attr.data-id]="idString">
      <div class="sprk-c-Tabs__buttons" role="tablist">
        <ng-content select="[sprkTabbedNavigationTab]"></ng-content>
      </div>
      <ng-content select="[sprkTabbedNavigationPane]"></ng-content>
      <ng-content></ng-content>
    </div>
  `
    }),
    __metadata("design:paramtypes", [ElementRef])
], SprkTabbedNavigationComponent);
export { SprkTabbedNavigationComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3Byay10YWJiZWQtbmF2aWdhdGlvbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ac3BhcmtkZXNpZ25zeXN0ZW0vc3BhcmstYW5ndWxhci8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL3NwcmstdGFiYmVkLW5hdmlnYXRpb24vc3Byay10YWJiZWQtbmF2aWdhdGlvbi5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsU0FBUyxFQUNULGVBQWUsRUFDZixVQUFVLEVBQ1YsWUFBWSxFQUNaLEtBQUssRUFDTCxTQUFTLEVBQ1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxLQUFLLENBQUMsTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxFQUNMLGtDQUFrQyxFQUNuQyxNQUFNLHdHQUF3RyxDQUFDO0FBQ2hILE9BQU8sRUFDTCxnQ0FBZ0MsRUFDakMsTUFBTSxvR0FBb0csQ0FBQztBQWM1RyxJQUFhLDZCQUE2QixHQUExQyxNQUFhLDZCQUE2QjtJQStSeEM7O09BRUc7SUFDSCxZQUFtQixHQUFlO1FBQWYsUUFBRyxHQUFILEdBQUcsQ0FBWTtRQWxRbEM7O1dBRUc7UUFDSCxnQkFBVyxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUMzQjs7V0FFRztRQUNILGdCQUFXLEdBQUcsNkJBQTZCLENBQUM7UUE0UDFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUEzUEQ7O09BRUc7SUFFSCxPQUFPLENBQUMsTUFBTTtRQUNaLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLHFCQUFxQixDQUFDLEVBQUU7WUFDM0QsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0JB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VSw2QkFBNkI7SUFaekMsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLHdCQUF3QjtRQUNsQyxRQUFRLEVBQUU7Ozs7Ozs7O0dBUVQ7S0FDRixDQUFDO3FDQW1Td0IsVUFBVTtHQWxTdkIsNkJBQTZCLENBcVN6QztTQXJTWSw2QkFBNkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlckNvbnRlbnRJbml0LFxuICBDb21wb25lbnQsXG4gIENvbnRlbnRDaGlsZHJlbixcbiAgRWxlbWVudFJlZixcbiAgSG9zdExpc3RlbmVyLFxuICBJbnB1dCxcbiAgUXVlcnlMaXN0XG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHtcbiAgU3Bya1RhYmJlZE5hdmlnYXRpb25QYW5lbERpcmVjdGl2ZVxufSBmcm9tICcuLi8uLi9kaXJlY3RpdmVzL3RhYmJlZC1uYXZpZ2F0aW9uL3NwcmstdGFiYmVkLW5hdmlnYXRpb24tcGFuZWwvc3Byay10YWJiZWQtbmF2aWdhdGlvbi1wYW5lbC5kaXJlY3RpdmUnO1xuaW1wb3J0IHtcbiAgU3Bya1RhYmJlZE5hdmlnYXRpb25UYWJEaXJlY3RpdmVcbn0gZnJvbSAnLi4vLi4vZGlyZWN0aXZlcy90YWJiZWQtbmF2aWdhdGlvbi9zcHJrLXRhYmJlZC1uYXZpZ2F0aW9uLXRhYi9zcHJrLXRhYmJlZC1uYXZpZ2F0aW9uLXRhYi5kaXJlY3RpdmUnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdzcHJrLXRhYmJlZC1uYXZpZ2F0aW9uJyxcbiAgdGVtcGxhdGU6IGBcbiAgICA8ZGl2IFtuZ0NsYXNzXT1cImdldENsYXNzZXMoKVwiIFthdHRyLmRhdGEtaWRdPVwiaWRTdHJpbmdcIj5cbiAgICAgIDxkaXYgY2xhc3M9XCJzcHJrLWMtVGFic19fYnV0dG9uc1wiIHJvbGU9XCJ0YWJsaXN0XCI+XG4gICAgICAgIDxuZy1jb250ZW50IHNlbGVjdD1cIltzcHJrVGFiYmVkTmF2aWdhdGlvblRhYl1cIj48L25nLWNvbnRlbnQ+XG4gICAgICA8L2Rpdj5cbiAgICAgIDxuZy1jb250ZW50IHNlbGVjdD1cIltzcHJrVGFiYmVkTmF2aWdhdGlvblBhbmVdXCI+PC9uZy1jb250ZW50PlxuICAgICAgPG5nLWNvbnRlbnQ+PC9uZy1jb250ZW50PlxuICAgIDwvZGl2PlxuICBgXG59KVxuZXhwb3J0IGNsYXNzIFNwcmtUYWJiZWROYXZpZ2F0aW9uQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCB7XG4gIC8qKlxuICAgKiBFeHBlY3RzIGEgc3BhY2Ugc2VwYXJhdGVkIHN0cmluZ1xuICAgKiBvZiBjbGFzc2VzIHRvIGJlIGFkZGVkIHRvIHRoZVxuICAgKiBjb21wb25lbnQuXG4gICAqL1xuICBASW5wdXQoKVxuICBhZGRpdGlvbmFsQ2xhc3Nlczogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIHZhbHVlIHN1cHBsaWVkIHdpbGwgYmUgYXNzaWduZWRcbiAgICogdG8gdGhlIGBkYXRhLWlkYCBhdHRyaWJ1dGUgb24gdGhlXG4gICAqIGNvbXBvbmVudC4gVGhpcyBpcyBpbnRlbmRlZCB0byBiZVxuICAgKiB1c2VkIGFzIGEgc2VsZWN0b3IgZm9yIGF1dG9tYXRlZFxuICAgKiB0b29scy4gVGhpcyB2YWx1ZSBzaG91bGQgYmUgdW5pcXVlXG4gICAqIHBlciBwYWdlLlxuICAgKi9cbiAgQElucHV0KClcbiAgaWRTdHJpbmc6IHN0cmluZztcbiAgLyoqXG4gICAqIFRoaXMgY29tcG9uZW50IGV4cGVjdHMgY2hpbGRyZW4gYDxidXR0b24+YCBlbGVtZW50c1xuICAgKiB3aXRoIHRoZSBgU3Bya1RhYmJlZE5hdmlnYXRpb25UYWJEaXJlY3RpdmVgIG9uIHRoZW0uXG4gICAqIFRoZXNlIHNlcnZlIGFzIHRoZSBUYWJzLlxuICAgKi9cbiAgQENvbnRlbnRDaGlsZHJlbihTcHJrVGFiYmVkTmF2aWdhdGlvblRhYkRpcmVjdGl2ZSlcbiAgdGFiczogUXVlcnlMaXN0PFNwcmtUYWJiZWROYXZpZ2F0aW9uVGFiRGlyZWN0aXZlPjtcbiAgLyoqXG4gICAqIFRoaXMgY29tcG9uZW50IGV4cGVjdHMgY2hpbGRyZW4gYDxkaXY+YCBlbGVtZW50c1xuICAgKiB3aXRoIHRoZSBgU3Bya1RhYmJlZE5hdmlnYXRpb25QYW5lbERpcmVjdGl2ZWAgb24gdGhlbS5cbiAgICogVGhlc2Ugc2VydmUgYXMgdGhlIFBhbmVscy5cbiAgICovXG4gIEBDb250ZW50Q2hpbGRyZW4oU3Bya1RhYmJlZE5hdmlnYXRpb25QYW5lbERpcmVjdGl2ZSlcbiAgcGFuZWxzOiBRdWVyeUxpc3Q8U3Bya1RhYmJlZE5hdmlnYXRpb25QYW5lbERpcmVjdGl2ZT47XG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBjb21wb25lbnRJRCA9IF8udW5pcXVlSWQoKTtcbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIGFjdGl2ZUNsYXNzID0gJ3NwcmstYy1UYWJzX19idXR0b24tLWFjdGl2ZSc7XG5cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIEBIb3N0TGlzdGVuZXIoJ2NsaWNrJywgWyckZXZlbnQnXSlcbiAgb25DbGljaygkZXZlbnQpIHtcbiAgICBpZiAoJGV2ZW50LnRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoJ3NwcmstYy1UYWJzX19idXR0b24nKSkge1xuICAgICAgY29uc3QgYWN0aXZlUGFuZWwgPSB0aGlzLnBhbmVscy5maW5kKHBhbmVsID0+IHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICBwYW5lbC5yZWYubmF0aXZlRWxlbWVudC5pZCA9PT1cbiAgICAgICAgICAkZXZlbnQudGFyZ2V0LmdldEF0dHJpYnV0ZSgnYXJpYS1jb250cm9scycpXG4gICAgICAgICk7XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5yZXNldFRhYnMoXG4gICAgICAgIHRoaXMudGFicy5tYXAodGFiID0+IHRhYi5yZWYubmF0aXZlRWxlbWVudCksXG4gICAgICAgIHRoaXMucGFuZWxzLm1hcChwYW5lbCA9PiBwYW5lbC5yZWYubmF0aXZlRWxlbWVudCksXG4gICAgICAgIHRoaXMuYWN0aXZlQ2xhc3NcbiAgICAgICk7XG5cbiAgICAgIHRoaXMuc2V0QWN0aXZlVGFiKFxuICAgICAgICAkZXZlbnQudGFyZ2V0LFxuICAgICAgICBhY3RpdmVQYW5lbC5yZWYubmF0aXZlRWxlbWVudCxcbiAgICAgICAgdGhpcy5hY3RpdmVDbGFzc1xuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgQEhvc3RMaXN0ZW5lcignd2luZG93OnJlc2l6ZScpXG4gIG9uUmVzaXplKCkge1xuICAgIHRoaXMuYXJpYU9yaWVudGF0aW9uKHdpbmRvdy5pbm5lcldpZHRoLCB0aGlzLnJlZi5uYXRpdmVFbGVtZW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBASG9zdExpc3RlbmVyKCdrZXlkb3duJywgWyckZXZlbnQnXSlcbiAgb25LZXlkb3duKCRldmVudCkge1xuICAgIGNvbnN0IGlzVGFic0J1dHRvbiA9ICRldmVudC50YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKCdzcHJrLWMtVGFic19fYnV0dG9uJyk7XG4gICAgaWYgKCFpc1RhYnNCdXR0b24pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBrZXlzID0ge1xuICAgICAgZW5kOiAzNSxcbiAgICAgIGhvbWU6IDM2LFxuICAgICAgbGVmdDogMzcsXG4gICAgICB1cDogMzgsXG4gICAgICByaWdodDogMzksXG4gICAgICBkb3duOiA0MCxcbiAgICAgIHRhYjogOVxuICAgIH07XG5cbiAgICBjb25zdCB0YWJFbGVtZW50cyA9IHRoaXMudGFicy5tYXAodGFiID0+IHRhYi5yZWYubmF0aXZlRWxlbWVudCk7XG4gICAgY29uc3QgcGFuZWxFbGVtZW50cyA9IHRoaXMucGFuZWxzLm1hcChwYW5lbCA9PiBwYW5lbC5yZWYubmF0aXZlRWxlbWVudCk7XG5cbiAgICBpZiAoJGV2ZW50LmtleUNvZGUgPT09IGtleXMubGVmdCB8fCAkZXZlbnQua2V5Q29kZSA9PT0ga2V5cy51cCkge1xuICAgICAgdGhpcy5pbmNyZW1lbnRUYWIodGFiRWxlbWVudHMsIHBhbmVsRWxlbWVudHMsIHRoaXMuYWN0aXZlQ2xhc3MsIC0xKTtcbiAgICB9IGVsc2UgaWYgKCRldmVudC5rZXlDb2RlID09PSBrZXlzLnJpZ2h0IHx8ICRldmVudC5rZXlDb2RlID09PSBrZXlzLmRvd24pIHtcbiAgICAgIHRoaXMuaW5jcmVtZW50VGFiKHRhYkVsZW1lbnRzLCBwYW5lbEVsZW1lbnRzLCB0aGlzLmFjdGl2ZUNsYXNzLCAxKTtcbiAgICB9IGVsc2UgaWYgKCRldmVudC5rZXlDb2RlID09PSBrZXlzLnRhYikge1xuICAgICAgaWYgKCRldmVudC50YXJnZXQuZ2V0QXR0cmlidXRlKCdyb2xlJykgPT09ICd0YWInKSB7XG4gICAgICAgICRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBwYW5lbEVsZW1lbnRzW1xuICAgICAgICAgIHRoaXMuZ2V0QWN0aXZlVGFiSW5kZXgodGFiRWxlbWVudHMsIHRoaXMuYWN0aXZlQ2xhc3MpXG4gICAgICAgIF0uZm9jdXMoKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKCRldmVudC5rZXlDb2RlID09PSBrZXlzLmhvbWUpIHtcbiAgICAgIHRoaXMuZ29Ub0VuZFRhYih0YWJFbGVtZW50cywgcGFuZWxFbGVtZW50cywgdGhpcy5hY3RpdmVDbGFzcywgLTEpO1xuICAgIH0gZWxzZSBpZiAoJGV2ZW50LmtleUNvZGUgPT09IGtleXMuZW5kKSB7XG4gICAgICB0aGlzLmdvVG9FbmRUYWIodGFiRWxlbWVudHMsIHBhbmVsRWxlbWVudHMsIHRoaXMuYWN0aXZlQ2xhc3MsIDEpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBnZXRDbGFzc2VzKCk6IHN0cmluZyB7XG4gICAgY29uc3QgY2xhc3NBcnJheTogc3RyaW5nW10gPSBbJ3NwcmstYy1UYWJzJ107XG5cbiAgICBpZiAodGhpcy5hZGRpdGlvbmFsQ2xhc3Nlcykge1xuICAgICAgdGhpcy5hZGRpdGlvbmFsQ2xhc3Nlcy5zcGxpdCgnICcpLmZvckVhY2goY2xhc3NOYW1lID0+IHtcbiAgICAgICAgY2xhc3NBcnJheS5wdXNoKGNsYXNzTmFtZSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2xhc3NBcnJheS5qb2luKCcgJyk7XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgbmdBZnRlckNvbnRlbnRJbml0KCk6IHZvaWQge1xuICAgIGxldCB0YWJJRHMgPSBbXTtcbiAgICBsZXQgcGFuZWxJRHMgPSBbXTtcblxuICAgIGlmICh0aGlzLnRhYnMgJiYgdGhpcy5wYW5lbHMpIHtcbiAgICAgIHRoaXMudGFicy5mb3JFYWNoKCh0YWIsIGluZGV4KSA9PiB7XG4gICAgICAgIGNvbnN0IHRhYklEID0gYHRhYmJlZC1uYXZpZ2F0aW9uLSR7dGhpcy5jb21wb25lbnRJRH0tdGFiLSR7aW5kZXh9YDtcbiAgICAgICAgY29uc3QgcGFuZWxJRCA9IGB0YWJiZWQtbmF2aWdhdGlvbi0ke3RoaXMuY29tcG9uZW50SUR9LXBhbmVsLSR7aW5kZXh9YDtcblxuICAgICAgICB0YWIucmVmLm5hdGl2ZUVsZW1lbnQuc2V0QXR0cmlidXRlKCdpZCcsIHRhYklEKTtcbiAgICAgICAgdGFiLnJlZi5uYXRpdmVFbGVtZW50LnNldEF0dHJpYnV0ZSgnYXJpYS1jb250cm9scycsIHBhbmVsSUQpO1xuICAgICAgICB0YWJJRHMucHVzaCh0YWJJRCk7XG4gICAgICAgIHBhbmVsSURzLnB1c2gocGFuZWxJRCk7XG4gICAgICB9KTtcblxuICAgICAgdGFiSURzID0gdGFiSURzLnJldmVyc2UoKTtcbiAgICAgIHBhbmVsSURzID0gcGFuZWxJRHMucmV2ZXJzZSgpO1xuXG4gICAgICB0aGlzLnBhbmVscy5mb3JFYWNoKHBhbmVsID0+IHtcbiAgICAgICAgcGFuZWwucmVmLm5hdGl2ZUVsZW1lbnQuc2V0QXR0cmlidXRlKCdpZCcsIHBhbmVsSURzLnBvcCgpKTtcbiAgICAgICAgcGFuZWwucmVmLm5hdGl2ZUVsZW1lbnQuc2V0QXR0cmlidXRlKCdhcmlhLWxhYmVsbGVkYnknLCB0YWJJRHMucG9wKCkpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIGFyaWFPcmllbnRhdGlvbih3aWR0aCwgZWxlbWVudCkge1xuICAgIC8vIHN3aXRjaCBhcmlhLW9yaWVudGF0aW9uIG9uIG1vYmlsZSAoYmFzZWQgb24gX3RhYnMuc2NzcyBicmVha3BvaW50KVxuICAgIGlmICh3aWR0aCA8PSA3MzYpIHtcbiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdhcmlhLW9yaWVudGF0aW9uJywgJ3ZlcnRpY2FsJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdhcmlhLW9yaWVudGF0aW9uJywgJ2hvcml6b250YWwnKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgZ2V0QWN0aXZlVGFiSW5kZXgodGFicywgYWN0aXZlQ2xhc3MpIHtcbiAgICBsZXQgYWN0aXZlSW5kZXggPSBudWxsO1xuICAgIHRhYnMuZm9yRWFjaCgodGFiLCBpbmRleCkgPT4ge1xuICAgICAgaWYgKFxuICAgICAgICB0YWIuY2xhc3NMaXN0LmNvbnRhaW5zKGFjdGl2ZUNsYXNzIHx8ICdzcHJrLWMtVGFic19fYnV0dG9uLS1hY3RpdmUnKVxuICAgICAgKSB7XG4gICAgICAgIGFjdGl2ZUluZGV4ID0gaW5kZXg7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gYWN0aXZlSW5kZXg7XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgcmVzZXRUYWJzKHRhYnMsIHRhYnBhbmVscywgYWN0aXZlQ2xhc3MpIHtcbiAgICB0YWJzLmZvckVhY2godGFiID0+IHtcbiAgICAgIHRhYi5jbGFzc0xpc3QucmVtb3ZlKGFjdGl2ZUNsYXNzIHx8ICdzcHJrLWMtVGFic19fYnV0dG9uLS1hY3RpdmUnKTtcbiAgICAgIHRhYi5yZW1vdmVBdHRyaWJ1dGUoJ3RhYmluZGV4Jyk7XG4gICAgICB0YWIuc2V0QXR0cmlidXRlKCdhcmlhLXNlbGVjdGVkJywgJ2ZhbHNlJyk7XG4gICAgICB0YWJwYW5lbHMuZm9yRWFjaChwYW5lbCA9PiB7XG4gICAgICAgIHBhbmVsLmNsYXNzTGlzdC5hZGQoJ3NwcmstdS1IaWRlV2hlbkpzJyk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBpbmNyZW1lbnRUYWIodGFicywgdGFicGFuZWxzLCBhY3RpdmVDbGFzcywgZGlyZWN0aW9uKSB7XG4gICAgbGV0IGFjdGl2ZUluZGV4ID0gdGhpcy5nZXRBY3RpdmVUYWJJbmRleCh0YWJzLCBhY3RpdmVDbGFzcyk7XG5cbiAgICBsZXQgZm91bmROZXdJbmRleCA9IGZhbHNlO1xuXG4gICAgLy8gU3RhcnQgbG9va2luZyBmb3IgdGhlIG5leHQgYXZhaWxhYmxlIHRhYlxuICAgIHdoaWxlIChmb3VuZE5ld0luZGV4ID09PSBmYWxzZSkge1xuICAgICAgLy8gaWYgdGhlIG5leHQgdGFiIHdvdWxkIGJlIG9mZiB0aGUgbGVmdCBvZiB0aGUgdGFic3RyaXBcbiAgICAgIGlmIChhY3RpdmVJbmRleCArIGRpcmVjdGlvbiA8IDApIHtcbiAgICAgICAgLy8gbG9vcCB0byB0aGUgZW5kIGFuZCBrZWVwIGxvb2tpbmdcbiAgICAgICAgYWN0aXZlSW5kZXggPSB0YWJzLmxlbmd0aDtcblxuICAgICAgLy8gaWYgdGhlIG5leHQgdGFiIHdvdWxkIGJlIG9mZiB0aGUgcmlnaHQgb2YgdGhlIHRhYnN0cmlwXG4gICAgICB9IGVsc2UgaWYgKGFjdGl2ZUluZGV4ICsgZGlyZWN0aW9uID49IHRhYnMubGVuZ3RoKSB7XG4gICAgICAgIC8vIGxvb3AgYmFjayB0byB0aGUgYmVnaW5uaW5nIGFuZCBrZWVwIGxvb2tpbmdcbiAgICAgICAgYWN0aXZlSW5kZXggPSAtMTtcblxuICAgICAgLy8gSWYgdGhlIG5leHQgdGFiIGlzIG5vdCBkaXNhYmxlZFxuICAgICAgfSBlbHNlIGlmICghdGFic1thY3RpdmVJbmRleCArIGRpcmVjdGlvbl0uaGFzQXR0cmlidXRlKCdkaXNhYmxlZCcpKSB7XG4gICAgICAgIC8vIG1vdmUgdG8gdGhlIG5leHQgdGFiXG4gICAgICAgIGFjdGl2ZUluZGV4ICs9IGRpcmVjdGlvbjtcbiAgICAgICAgLy8gc3RvcCBsb29raW5nIGZvciB0aGUgY29ycmVjdCB0YWJcbiAgICAgICAgZm91bmROZXdJbmRleCA9IHRydWU7XG5cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIG1vdmUgdG8gdGhlIG5leHQgdGFiIGFuZCBrZWVwIGxvb2tpbmdcbiAgICAgICAgYWN0aXZlSW5kZXggKz0gZGlyZWN0aW9uO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGRlc2VsZWN0IGFsbCB0YWJzXG4gICAgdGhpcy5yZXNldFRhYnModGFicywgdGFicGFuZWxzLCBhY3RpdmVDbGFzcyk7XG4gICAgLy8gc2VsZWN0IHRoZSBjb3JyZWN0IHRhYlxuICAgIHRoaXMuc2V0QWN0aXZlVGFiKHRhYnNbYWN0aXZlSW5kZXhdLCB0YWJwYW5lbHNbYWN0aXZlSW5kZXhdLCBhY3RpdmVDbGFzcyk7XG4gIH1cblxuICBnb1RvRW5kVGFiKHRhYnMsIHRhYnBhbmVscywgYWN0aXZlQ2xhc3MsIGRpcmVjdGlvbikge1xuICAgIGxldCBuZXdBY3RpdmVJbmRleDtcblxuICAgIC8vIGlmIGRpcmVjdGlvbiBpcyBwb3NpdGl2ZSwgZ28gdG8gdGhlIHJpZ2h0LW1vc3QgdGFiXG4gICAgaWYgKGRpcmVjdGlvbiA+IDApIHtcbiAgICAgIG5ld0FjdGl2ZUluZGV4ID0gdGFicy5sZW5ndGggLSAxO1xuXG4gICAgLy8gZWxzZSBnbyB0byB0aGUgbGVmdC1tb3N0IHRhYlxuICAgIH0gZWxzZSB7XG4gICAgICBuZXdBY3RpdmVJbmRleCA9IDA7XG4gICAgfVxuXG4gICAgbGV0IGZvdW5kTmV3SW5kZXggPSBmYWxzZTtcblxuICAgIC8vIHN0ZXAgdGhyb3VnaCB0aGUgdGFicyB1bnRpbCB3ZSBmaW5kIG9uZSB0aGF0IGlzbid0IGRpc2FibGVkXG4gICAgd2hpbGUgKGZvdW5kTmV3SW5kZXggPT09IGZhbHNlKSB7XG5cbiAgICAgIC8vIGlmIHRoaXMgdGFiIGlzIG5vdCBkaXNhYmxlZFxuICAgICAgaWYgKCF0YWJzW25ld0FjdGl2ZUluZGV4XS5oYXNBdHRyaWJ1dGUoJ2Rpc2FibGVkJykpIHtcblxuICAgICAgICAvLyBzdG9wIGxvb2tpbmcgZm9yIHRoZSBjb3JyZWN0IHRhYlxuICAgICAgICBmb3VuZE5ld0luZGV4ID0gdHJ1ZTtcblxuICAgICAgLy8gZWxzZSBzdGVwIG9uZSB0YWIgYXdheSBmcm9tIHRoZSBlbmQgYW5kIGtlZXAgbG9va2luZ1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbmV3QWN0aXZlSW5kZXggLT0gZGlyZWN0aW9uO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMucmVzZXRUYWJzKHRhYnMsIHRhYnBhbmVscywgYWN0aXZlQ2xhc3MpO1xuICAgIHRoaXMuc2V0QWN0aXZlVGFiKHRhYnNbbmV3QWN0aXZlSW5kZXhdLCB0YWJwYW5lbHNbbmV3QWN0aXZlSW5kZXhdLCBhY3RpdmVDbGFzcyk7XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgc2V0QWN0aXZlVGFiKHRhYiwgdGFicGFuZWwsIGFjdGl2ZUNsYXNzKSB7XG4gICAgdGFiLmNsYXNzTGlzdC5hZGQoYWN0aXZlQ2xhc3MgfHwgJ3NwcmstYy1UYWJzX19idXR0b24tLWFjdGl2ZScpO1xuICAgIHRhYi5zZXRBdHRyaWJ1dGUoJ3RhYmluZGV4JywgJzAnKTtcbiAgICB0YWIuc2V0QXR0cmlidXRlKCdhcmlhLXNlbGVjdGVkJywgJ3RydWUnKTtcbiAgICBpZiAodGFicGFuZWwpIHtcbiAgICAgIHRhYnBhbmVsLmNsYXNzTGlzdC5yZW1vdmUoJ3NwcmstdS1IaWRlV2hlbkpzJyk7XG4gICAgfVxuICAgIHRhYi5mb2N1cygpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyByZWY6IEVsZW1lbnRSZWYpIHtcbiAgICB0aGlzLmFyaWFPcmllbnRhdGlvbih3aW5kb3cuaW5uZXJXaWR0aCwgdGhpcy5yZWYubmF0aXZlRWxlbWVudCk7XG4gIH1cbn1cbiJdfQ==